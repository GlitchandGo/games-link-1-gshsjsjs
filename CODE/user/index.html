<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Cookie Saver & Exporter</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 2em; }
        #container { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 2em; max-width: 600px; margin: auto; }
        input, button, textarea { width: 100%; margin-bottom: 1em; padding: 0.7em; font-size: 1em; }
        textarea { height: 120px; }
        .hidden { display: none; }
        #cookie-table { width: 100%; border-collapse: collapse; margin-bottom: 1em; background: #f4f4f4; border-radius: 4px; overflow-x: auto; }
        #cookie-table th, #cookie-table td { border: 1px solid #ddd; padding: 0.5em 0.7em; text-align: left; }
        #cookie-table th { background: #e9e9e9; }
        #cookie-table tr:nth-child(even) { background: #fafafa; }
        #cookie-table tr:hover { background: #f1f7ff; }
        #cookie-table-container { max-height: 250px; overflow-y: auto; margin-bottom: 1em; }
        #message { min-height: 1.5em; }
        button { cursor: pointer; }
        h2, h3, h4 { margin-top: 0.5em; }
    </style>
</head>
<body>
    <div id="container">
        <h2>Cookie Saver & Exporter</h2>
        <div id="cookie-section">
            <h3>Your Cookies & Local Storage</h3>
            <div id="cookie-table-container">
                <table id="cookie-table">
                    <thead>
                        <tr>
                            <th>Cookie Name</th>
                            <th>Value</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Cookies will be rendered here -->
                    </tbody>
                </table>
            </div>
            <div id="localstorage-table-container" style="max-height:250px; overflow:auto; margin-bottom:1em; background:#f4f4f4; border-radius:4px;"></div>
            <button id="refresh-cookies">Refresh Data</button>
            <button id="export-all">Export All (Cookies + Local Storage)</button>
            <input type="file" id="import-all-file" accept="application/json">
            <button id="import-all">Import All (Cookies + Local Storage)</button>
            <button id="cloud-save-all">Export All to Cloud</button>
            <button id="cloud-load-all">Import All from Cloud</button>
            <button id="cloud-export-all">Download Cloud Data</button>
            <input type="file" id="cloud-import-all-file" accept="application/json">
            <button id="cloud-import-all">Upload Cloud Data</button>
            <div id="message" style="color:green;"></div>
        </div>
    </div>

    <div id="signup-modal" class="hidden" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9999;">
        <div style="background:#fff;padding:2em 2em 1.5em 2em;border-radius:10px;box-shadow:0 4px 16px #0002;max-width:350px;width:95vw;text-align:center;">
            <h3 style='margin-top:0'>Sign Up</h3>
            <input id='signup-username' type='text' maxlength='32' placeholder='Username' style='width:90%;padding:0.7em;margin-bottom:1em;font-size:1em;'><br>
            <input id='signup-password' type='password' maxlength='64' placeholder='Password' style='width:90%;padding:0.7em;margin-bottom:1em;font-size:1em;'><br>
            <input id='signup-name' type='text' maxlength='64' placeholder='Full Name' style='width:90%;padding:0.7em;margin-bottom:1em;font-size:1em;'><br>
            <input id='signup-email' type='email' maxlength='64' placeholder='Email' style='width:90%;padding:0.7em;margin-bottom:1em;font-size:1em;'><br>
            <div id='signup-error' style='color:red;min-height:1.5em;'></div>
            <button id='signup-btn' style='background:#007bff;color:#fff;padding:0.7em 1.5em;border:none;border-radius:6px;font-size:1em;cursor:pointer;'>Sign Up</button>
            <button id='signup-cancel' style='margin-left:1em;background:#f4f4f4;color:#007bff;border:1px solid #007bff;border-radius:6px;'>Cancel</button>
        </div>
    </div>
    <div id="verify-modal" class="hidden" style="position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);display:flex;align-items:center;justify-content:center;z-index:9999;">
        <div style="background:#fff;padding:2em 2em 1.5em 2em;border-radius:10px;box-shadow:0 4px 16px #0002;max-width:350px;width:95vw;text-align:center;">
            <h3 style='margin-top:0'>Verify Your Account</h3>
            <p style='font-size:1em;color:#333;'>A verification code was sent to your email.<br>Enter it below to activate your account.</p>
            <input id='verify-code-input' type='text' maxlength='8' placeholder='Verification Code' style='width:90%;padding:0.7em;margin-bottom:1em;font-size:1em;'>
            <div id='verify-error' style='color:red;min-height:1.5em;'></div>
            <button id='verify-btn' style='background:#007bff;color:#fff;padding:0.7em 1.5em;border:none;border-radius:6px;font-size:1em;cursor:pointer;'>Verify</button>
        </div>
    </div>

<script>
    let BACKEND_URL = '';
    fetch('/backend.json')
        .then(res => res.json())
        .then(cfg => {
            BACKEND_URL = cfg.url.replace(/\/$/, '');
            initApp();
        });

    function initApp() {
        function checkCookie() {
            const cookies = document.cookie.split("; ");
            const accessCookie = cookies.find(row => row.startsWith("access="));

            if (!accessCookie || accessCookie.split("=")[1] !== "1") {
                window.location.href = "/index.html"; // Redirect if no valid cookie
            }
        }

        window.onload = function () {
            checkCookie(); // Verify cookie before loading the page

            // Check for permanent ban on page load
            if (localStorage.getItem('banned_permanent') === '1') {
                alert('This device is permanently banned from creating or accessing accounts.');
                window.location.href = '/'; // Or show a blocked message
            }
        };

        // Minimal, robust cookie exporter UI
        function getAllCookies() {
            // This only gets cookies for the current domain (not all URLs/domains)
            return document.cookie.split(';').reduce((acc, c) => {
                const idx = c.indexOf('=');
                if (idx > -1) {
                    const k = c.slice(0, idx).trim();
                    const v = c.slice(idx + 1);
                    acc[k] = decodeURIComponent(v);
                }
                return acc;
            }, {});
        }
        function getUserCookies() {
            // Exclude only sensitive cookies, but include all others (including game saves)
            const exclude = [
                'cookie_saver_email',
                'cookie_saver_name',
                'cookie_saver_password',
                'newsletter_hide',
                'cookie_saver_signedup',
                'cookie_saver_username',
                'access'
            ];
            const all = getAllCookies();
            const filtered = {};
            Object.keys(all).forEach(k => {
                if (!exclude.includes(k)) filtered[k] = all[k];
            });
            return filtered;
        }
        function showCookies() {
            const cookies = getUserCookies();
            const tbody = document.querySelector('#cookie-table tbody');
            tbody.innerHTML = '';
            const keys = Object.keys(cookies);
            if (keys.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 3;
                td.textContent = 'No cookies found.';
                tr.appendChild(td);
                tbody.appendChild(tr);
            } else {
                keys.forEach(key => {
                    const tr = document.createElement('tr');
                    const tdName = document.createElement('td');
                    tdName.textContent = key;
                    const tdValue = document.createElement('td');
                    tdValue.textContent = cookies[key];
                    // Edit button
                    const tdEdit = document.createElement('td');
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.onclick = function() {
                        const newValue = prompt('Edit cookie value for ' + key + ':', cookies[key]);
                        if (newValue !== null) {
                            document.cookie = key + '=' + encodeURIComponent(newValue) + '; path=/';
                            showCookies();
                        }
                    };
                    // Delete button
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.marginLeft = '8px';
                    delBtn.onclick = function() {
                        document.cookie = key + '=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                        showCookies();
                    };
                    tdEdit.appendChild(editBtn);
                    tdEdit.appendChild(delBtn);
                    tr.appendChild(tdName);
                    tr.appendChild(tdValue);
                    tr.appendChild(tdEdit);
                    tbody.appendChild(tr);
                });
            }
            showLocalStorage();
        }
        // Helper to get/set/remove from localStorage
        function getLocal(key) {
            return localStorage.getItem(key);
        }
        function setLocal(key, value) {
            localStorage.setItem(key, value);
        }
        function removeLocal(key) {
            localStorage.removeItem(key);
        }
        // Use localStorage for account data
        function getAccountUsername() {
            return getLocal('cookie_saver_username');
        }
        function getAccountPassword() {
            return getLocal('cookie_saver_password');
        }
        // Show localStorage data
        function showLocalStorage() {
            let container = document.getElementById('localstorage-table-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'localstorage-table-container';
                container.style = 'max-height:250px; overflow:auto; margin-bottom:1em; background:#f4f4f4; border-radius:4px;';
                document.getElementById('cookie-section').appendChild(container);
            }
            let table = document.getElementById('localstorage-table');
            if (!table) {
                table = document.createElement('table');
                table.id = 'localstorage-table';
                table.style = 'width:100%; min-width:400px; background:#f4f4f4; border-radius:4px; overflow-x:auto;';
                table.innerHTML = '<thead><tr><th>Key</th><th>Value</th><th>Actions</th></tr></thead><tbody></tbody>';
                container.appendChild(table);
            }
            const tbody = table.querySelector('tbody');
            tbody.innerHTML = '';
            if (localStorage.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 3;
                td.textContent = 'No localStorage data found.';
                tr.appendChild(td);
                tbody.appendChild(tr);
            } else {
                Object.keys(localStorage).forEach(key => {
                    const tr = document.createElement('tr');
                    const tdKey = document.createElement('td');
                    tdKey.textContent = key;
                    const tdValue = document.createElement('td');
                    tdValue.textContent = localStorage.getItem(key);
                    tdValue.style.maxWidth = '300px';
                    tdValue.style.overflow = 'auto';
                    tdValue.style.whiteSpace = 'pre-wrap';
                    // Edit button
                    const tdEdit = document.createElement('td');
                    const editBtn = document.createElement('button');
                    editBtn.textContent = 'Edit';
                    editBtn.onclick = function() {
                        const newValue = prompt('Edit localStorage value for ' + key + ':', localStorage.getItem(key));
                        if (newValue !== null) {
                            localStorage.setItem(key, newValue);
                            showLocalStorage();
                        }
                    };
                    // Delete button
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.style.marginLeft = '8px';
                    delBtn.onclick = function() {
                        localStorage.removeItem(key);
                        showLocalStorage();
                    };
                    tdEdit.appendChild(editBtn);
                    tdEdit.appendChild(delBtn);
                    tr.appendChild(tdKey);
                    tr.appendChild(tdValue);
                    tr.appendChild(tdEdit);
                    tbody.appendChild(tr);
                });
            }
        }
        document.getElementById('refresh-cookies').onclick = showCookies;
        document.getElementById('export-all').onclick = function() {
            const cookies = getUserCookies();
            const local = {};
            Object.keys(localStorage).forEach(key => { local[key] = localStorage.getItem(key); });
            const data = { cookies, localStorage: local };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'cookies-localstorage.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        };
        document.getElementById('import-all').onclick = function() {
            const fileInput = document.getElementById('import-all-file');
            if (!fileInput.files.length) {
                document.getElementById('message').textContent = 'Please select a file to import.';
                document.getElementById('message').style.color = 'red';
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (data.cookies && typeof data.cookies === 'object') {
                        Object.keys(data.cookies).forEach(name => {
                            document.cookie = name + '=' + encodeURIComponent(data.cookies[name]) + '; path=/';
                        });
                    }
                    if (data.localStorage && typeof data.localStorage === 'object') {
                        Object.keys(data.localStorage).forEach(key => {
                            localStorage.setItem(key, data.localStorage[key]);
                        });
                    }
                    document.getElementById('message').textContent = 'Data imported successfully.';
                    document.getElementById('message').style.color = 'green';
                    showCookies();
                } catch {
                    document.getElementById('message').textContent = 'Invalid file format.';
                    document.getElementById('message').style.color = 'red';
                }
            };
            reader.readAsText(file);
        };
        // Combined cloud save
        document.getElementById('cloud-save-all').onclick = function() {
            const cookies = getUserCookies();
            const local = {};
            Object.keys(localStorage).forEach(key => { local[key] = localStorage.getItem(key); });
            const username = getAccountUsername();
            const password = getAccountPassword();
            if (!username || !password) {
                document.getElementById('message').textContent = 'No username/password found in localStorage.';
                document.getElementById('message').style.color = 'red';
                return;
            }
            fetch(BACKEND_URL + '/cookie-cloud', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    username,
                    password,
                    cookies,
                    localStorage: local,
                    timestamp: new Date().toISOString()
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data && data.success) {
                    document.getElementById('message').textContent = 'Cloud export successful!';
                    document.getElementById('message').style.color = 'green';
                } else {
                    document.getElementById('message').textContent = 'Cloud export failed: ' + (data && data.error ? data.error : 'Unknown error');
                    document.getElementById('message').style.color = 'red';
                }
            })
            .catch(() => {
                document.getElementById('message').textContent = 'Cloud export failed.';
                document.getElementById('message').style.color = 'red';
            });
        };
        // Combined cloud load
        document.getElementById('cloud-load-all').onclick = function() {
            const username = getAccountUsername();
            const password = getAccountPassword();
            if (!username || !password) {
                document.getElementById('message').textContent = 'No username/password found in localStorage.';
                document.getElementById('message').style.color = 'red';
                return;
            }
            fetch(BACKEND_URL + '/cookie-cloud?username=' + encodeURIComponent(username) + '&password=' + encodeURIComponent(password), {
                method: 'GET'
            })
            .then(res => res.json())
            .then(data => {
                if (data && (data.cookies || data.localStorage)) {
                    if (data.cookies) {
                        Object.keys(data.cookies).forEach(name => {
                            document.cookie = name + '=' + encodeURIComponent(data.cookies[name]) + '; path=/';
                        });
                    }
                    if (data.localStorage) {
                        Object.keys(data.localStorage).forEach(key => {
                            localStorage.setItem(key, data.localStorage[key]);
                        });
                    }
                    document.getElementById('message').textContent = 'Cloud import successful!';
                    document.getElementById('message').style.color = 'green';
                    showCookies();
                } else {
                    document.getElementById('message').textContent = 'Cloud import failed: ' + (data && data.error ? data.error : 'No data found');
                    document.getElementById('message').style.color = 'red';
                }
            })
            .catch(() => {
                document.getElementById('message').textContent = 'Cloud import failed.';
                document.getElementById('message').style.color = 'red';
            });
        };
        // Combined cloud export to file
        document.getElementById('cloud-export-all').onclick = function() {
            const username = getAccountUsername();
            const password = getAccountPassword();
            if (!username || !password) {
                document.getElementById('message').textContent = 'No username/password found in localStorage.';
                document.getElementById('message').style.color = 'red';
                return;
            }
            fetch(BACKEND_URL + '/cookie-cloud/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(res => {
                if (!res.ok) throw new Error('Export failed');
                return res.blob();
            })
            .then(blob => {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'cloud-data.json';
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                document.getElementById('message').textContent = 'Cloud data exported!';
                document.getElementById('message').style.color = 'green';
            })
            .catch(() => {
                document.getElementById('message').textContent = 'Cloud export failed.';
                document.getElementById('message').style.color = 'red';
            });
        };
        // Combined cloud import from file
        document.getElementById('cloud-import-all').onclick = function() {
            const fileInput = document.getElementById('cloud-import-all-file');
            if (!fileInput.files.length) {
                document.getElementById('message').textContent = 'Please select a file to upload.';
                document.getElementById('message').style.color = 'red';
                return;
            }
            const username = getAccountUsername();
            const password = getAccountPassword();
            if (!username || !password) {
                document.getElementById('message').textContent = 'No username/password found in localStorage.';
                document.getElementById('message').style.color = 'red';
                return;
            }
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const cloudData = JSON.parse(e.target.result);
                    fetch(BACKEND_URL + '/cookie-cloud/import', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username, password, data: cloudData })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.success) {
                            document.getElementById('message').textContent = 'Cloud data imported!';
                            document.getElementById('message').style.color = 'green';
                        } else {
                            document.getElementById('message').textContent = 'Cloud import failed: ' + (data && data.error ? data.error : 'Unknown error');
                            document.getElementById('message').style.color = 'red';
                        }
                    })
                    .catch(() => {
                        document.getElementById('message').textContent = 'Cloud import failed.';
                        document.getElementById('message').style.color = 'red';
                    });
                } catch {
                    document.getElementById('message').textContent = 'Invalid file format.';
                    document.getElementById('message').style.color = 'red';
                }
            };
            reader.readAsText(file);
        };
        showCookies();

        // Show signup modal
        function showSignupModal() {
            document.getElementById('signup-modal').classList.remove('hidden');
        }
        // Hide signup modal
        function hideSignupModal() {
            document.getElementById('signup-modal').classList.add('hidden');
        }
        // Show verify modal
        function showVerifyModal() {
            document.getElementById('verify-modal').classList.remove('hidden');
        }
        // Hide verify modal
        function hideVerifyModal() {
            document.getElementById('verify-modal').classList.add('hidden');
        }
        // Attach signup button to open modal
        const signupBtn = document.createElement('button');
        signupBtn.textContent = 'Sign Up for Account';
        signupBtn.style = 'margin-bottom:1em;background:#007bff;color:#fff;padding:0.7em 1.5em;border:none;border-radius:6px;font-size:1em;cursor:pointer;';
        signupBtn.onclick = showSignupModal;
        document.getElementById('container').insertBefore(signupBtn, document.getElementById('cookie-section'));
        // Signup logic
        document.getElementById('signup-btn').onclick = function() {
            const username = document.getElementById('signup-username').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            const name = document.getElementById('signup-name').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            if (!username || !password || !name || !email) {
                document.getElementById('signup-error').textContent = 'Please fill all fields.';
                return;
            }
            fetch(BACKEND_URL + '/cookie-signup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, name, email })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success && data.verification_required) {
                    hideSignupModal();
                    showVerifyModal();
                    // Store username for verification
                    window._signupUsername = username;
                } else {
                    document.getElementById('signup-error').textContent = data.error || 'Signup failed.';
                }
            })
            .catch(() => {
                document.getElementById('signup-error').textContent = 'Could not sign up.';
            });
        };
        document.getElementById('signup-cancel').onclick = hideSignupModal;
        // Verification logic
        document.getElementById('verify-btn').onclick = function() {
            const code = document.getElementById('verify-code-input').value.trim();
            if (!window._signupUsername || !code) {
                document.getElementById('verify-error').textContent = 'Please enter the code.';
                return;
            }
            fetch(BACKEND_URL + '/verify-account', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: window._signupUsername, code })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    hideVerifyModal();
                    alert('Account verified and created! You can now use all features.');
                    location.reload();
                } else {
                    document.getElementById('verify-error').textContent = data.error || 'Incorrect code.';
                }
            })
            .catch(() => {
                document.getElementById('verify-error').textContent = 'Could not verify code.';
            });
        };
    }
</script>
</body>
</html>
