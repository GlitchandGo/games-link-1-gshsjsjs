<!DOCTYPE html>
<html>
<head>
    <title>Live Devices</title>
    <style>
        body { font-family: Arial,sans-serif; background: #f9f9f9; margin: 0; padding: 2em; }
        #container { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 2em; max-width: 900px; margin: auto; }
        .device { margin-bottom: 1em; }
        .new { color: #1976d2; font-weight: bold; }
        .online { color: green; }
        .away { color: orange; }
        .offline { color: #888; }
        .id-link { cursor:pointer; text-decoration:underline; color:#1976d2; }
        #info { margin-top:2em; background:#f4f4f4; padding:1em; border-radius:6px; }
    </style>
</head>
<body>
<div id="container">
    <h2>Live Devices</h2>
    <div id="devicelist">Loading...</div>
    <div id="info"></div>
</div>
<script>
    function fetchDevices() {
        fetch('/live-data')
        .then(r => r.json())
        .then(db => {
            const now = Date.now();
            const weekAgo = now - 7 * 24 * 60 * 60 * 1000;
            let html = '';
            Object.values(db).forEach(dev => {
                const isNew = (dev.timestamp && new Date(dev.timestamp).getTime() > weekAgo);
                const status = (dev.status === 'online') ? 'online' : (dev.status === 'online-away' ? 'away' : 'offline');
                html += `<div class="device">
                    <span class="id-link${isNew ? ' new' : ''}" onclick="showInfo('${dev.device_code}')">${dev.device_code}</span>
                    <span class="${status}">[${status}]</span>
                    ${isNew ? '<span class="new">(new this week)</span>' : ''}
                </div>`;
            });
            document.getElementById('devicelist').innerHTML = html || 'No devices found';
            window.deviceDB = db;
        });
    }

    function showInfo(id) {
        const dev = window.deviceDB[id];
        if (!dev) return;
        let html = '<h3>Device: ' + id + '</h3>';
        html += '<pre>' + JSON.stringify(dev, null, 2) + '</pre>';
        document.getElementById('info').innerHTML = html;
    }

    fetchDevices();
    setInterval(fetchDevices, 5000);
</script>
</body>
</html>
